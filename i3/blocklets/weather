#!/usr/bin/env zsh

parse_weather_details () {
  local api_key="cabfc935d0f32912c7fc1f963648b2fd"
  local api_parameters="exclude=minutely,hourly,daily,alerts,flags&units=si"
  local city_id="29.98333,31.445127"
  local api_url="https://api.darksky.net/forecast/${api_key}/${city_id}?${api_parameters}"

  local response=$(curl -s "${api_url}")
  [[ -z $response ]] && exit 0

  forecast=$(echo "${response}" \
    | grep -o -e '\"icon\":\"[a-zA-Z-]*\"' \
    | awk -F ':' '{print $2}' \
    | tr -d '"')

  temperature=$(echo "${response}" \
    | grep -o -e '\"temperature\":\-\?[0-9]*' \
    | awk -F ':' '{print $2}' \
    | tr -d '"')
}

print_weather () {
  local sun_icon=""
  local night_icon=""
  local cloud_icon=""
  local rain_icon=""
  local snow_icon=""
  local wind_icon=""
  local storm_icon=""
  local fog_icon=""
  local celsius_symbol="°C"

  parse_weather_details
  case "${forecast}" in
    *clear-day*)    current_icon=$sun_icon;;
    *clear-night*)  current_icon=$night_icon;;
    *cloudy*)       current_icon=$cloud_icon;;
    *rain*)         current_icon=$rain_icon;;
    *snow*)         current_icon=$snow_icon;;
    *sleet*)        current_icon=$snow_icon;;
    *wind*)         current_icon=$wind_icon;;
    *fog*)          current_icon=$fog_icon;;
  esac

  weather="${current_icon} ${temperature}${celsius_symbol}"
  echo "${weather}"
  echo "${weather}"
}

print_weather
exit 0
